---
title: "LSH - BCS Gagnaborð"
author: ''
runtime: shiny
output:
  flexdashboard::flex_dashboard:
    orientation: columns
---

```{r global, include=FALSE, warning=FALSE}
library(flexdashboard)
library(shiny)
library(ggplot2)
library(plotly)
library(stringr)
library(dplyr)
library(readr)

# Functions
load_git_data <- function(type = c('length_of_stay_with_imputed', 'length_of_stay_empirical', 'transition_matrix', 'covid_simulation'),
                          data_folder = 'dashboard/input', 
                          start_date = '2020-04-02') {
  # Create URLs to csv files
  root_path <- 'https://raw.githubusercontent.com/tprunarsson/BCS/master'
  files <- sprintf('%s_%s.csv', seq.Date(from = as.Date(start_date), to = Sys.Date(), by = 1), type)

  #Get csv data to a list and row-bind all non-null results
  data_list <- list()
  for (file in files) {
    data_list[[file]] <- try(
      read.csv(file.path(root_path, data_folder, file)), silent = TRUE
    )
    # Add state column for transition data
    if (grepl('transition', type)) {
      data_list[[file]]$state <- names(data_list[[file]])
    }
    # Delete from list if csv does not exist add date col if file existed
    if (length(data_list[[file]]) < 2) {
      data_list[[file]] <- NULL
    } else {
      data_list[[file]]$date <- as.Date(str_extract(file, '\\d{4}-\\d{2}-\\d{2}'))
    }
  }
  bind_rows(data_list)
}

recode_states <- function(df_with_state) {
  stopifnot('state' %in% names(df_with_state))
  df_with_state %>% 
    mutate(state = state %>% recode(home='Heimaeinangrun',
                                    inpatient_ward='Legudeild',
                                    intensive_care_unit='Gjörgæsla'))
}
# Load csv data
data_length_of_stay <- load_git_data('length_of_stay_empirical') %>% 
    recode_states()

data_transition <- load_git_data('transition_matrix', data_folder = 'input')

# Set constants
start_date <- min(data_length_of_stay$date) # as.Date('2020-04-02')
end_date <- Sys.Date()
gagnagerdir <- unique(data_length_of_stay$censored)
aldurshopar <- unique(data_length_of_stay$age_group_simple) #list('0-50', '51+')
states <- unique(data_length_of_stay$state)
```

Stillingar {.sidebar}
=======================================================================

```{r}
sliderInput('dagsetning', 'Dagsetning:', min = start_date, max = end_date,
            value = end_date, step = 1, timeFormat = "%d %b")
checkboxGroupInput('aldur', label = 'Aldurshópar:', 
                   choices = aldurshopar, selected = aldurshopar)
checkboxGroupInput('state', label = 'Staða:', 
                   choices = states, selected = states)
checkboxGroupInput('gagnagerd', label = 'Censored:',
                   choices = gagnagerdir, selected = gagnagerdir)
selectInput('fill_by', 'Lita eftir:', c(names(data_length_of_stay)[1:3]), selected = 'censored')
selectInput('facet', 'Facet eftir:', c('-', names(data_length_of_stay)[1:3]))

```


Dreifingar {data-icon="fa-signal"}
=======================================================================

column {.tabset .tabset-fade}
-----------------------------------------------------------------------


### Length of Stay 

```{r}
dataset <- reactive({
  data_length_of_stay %>%  
    filter(date == input$dagsetning,
           state %in% input$state,
           age_group_simple %in% input$aldur, 
           censored %in% input$gagnagerd)
})

# renderText(print(as.Date(input$dagsetning, origin = '1970-01-01', format="%d %b")))
renderPlot({
  p <- ggplot(dataset(), aes(x=state_duration, y=count, fill = censored)) + 
    geom_col(position = 'dodge') +
    scale_fill_viridis_d() +
    theme_minimal()
  
  p <- p + aes_string(fill = input$fill_by)
  
  if (input$facet != '-')
    p <- p + facet_wrap(paste0('~', input$facet), scales = 'free')
  
  print(p)
})
```


<!-- Row -->
<!-- ----------------------------------------------------------------------- -->

### Transition Matrix Test [WIP]

```{r}
links <- list(
  source = c(0,1,0,1,2),
  target = c(1,2,3,3,3),
  value =  c(4,2,2,2,2))
  
nodes <-  list(
  label = c("home", "inpatient_ward", "intensive_care_unit", "recovered"),
  color = c("blue", "blue", "blue", "blue"),
  pad = 15,
  thickness = 20,
  line = list(
    color = "black",
    width = 0.5
  )
)

fig <- plot_ly(
  type = "sankey",
  orientation = "h",
  node = nodes,
  link = links
)

fig <- fig %>% layout(
  title = "Basic Sankey Diagram",
  font = list(
    size = 10
  )
)

fig
```


### ggPlotly test

```{r}
n <- 20
x1 <- rnorm(n); x2 <- rnorm(n)
y1 <- 2 * x1 + rnorm(n)
y2 <- 3 * x2 + (2 + rnorm(n))
A <- as.factor(rep(c(1, 2), each = n))
df <- data.frame(x = c(x1, x2), y = c(y1, y2), A = A)
fm <- lm(y ~ x + A, data = df)

p <- ggplot(data = cbind(df, pred = predict(fm)), aes(x = x, y = y, color = A))
p <- p + geom_point() + geom_line(aes(y = pred))
ggplotly(p)
```

Gagnagæði {data-icon="fa-tasks"}
=======================================================================


Skýrslur {id=skyrslur data-icon="fa-file-alt"}
=======================================================================

Column {width=100%}
-----------------------
<iframe style="position: absolute; height: 100%; border: none"></iframe>
```{r, echo=FALSE}
htmlbase_url <- 'https://htmlpreview.github.io/?https://raw.githubusercontent.com/tprunarsson/BCS/master/daily_report/'
this_report <- function() {
  URLencode(paste0(
    htmlbase_url, input$dagsetning, '-Flæði COVID-19 sjúklinga LSH.html'))
}
renderUI(
  htmltools::tags$iframe(height='1080', width='100%', title = "Skýrsla valins dags",
    src = this_report())
)
```

> Dagleg skýrsla - Veljið dagsetningu í stillingum
