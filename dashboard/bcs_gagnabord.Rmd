---
title: "LSH - BCS Gagnaborð"
author: ''
runtime: shiny
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    css: styles.css
---

```{r global, include=FALSE, warning=TRUE}
library(flexdashboard)
library(shiny)
library(plotly)
library(ggplot2)
library(stringr)
library(dplyr)
library(readr)
library(tidyr)
library(RCurl)
library(deSolve)
setwd("../lsh_data_processing")
source("covid19_lsh_data_processing.R")
source("help_functions.R")
setwd("../dashboard")
source('dashboard_functions.R')

#Load csv data
env_wdir <- Sys.getenv("ENV_WORKING_DIRECTORY")
data_path <- ifelse(env_wdir == "", 'input', file.path(env_wdir, 'input'))
bcs_data <- readRDS(file.path(data_path, 'bcs_data.rds'))
bcs_data$data_length_of_stay <- bcs_data$data_length_of_stay %>% recode_states()

# Set constants
start_date <- min(bcs_data$data_length_of_stay$date) # as.Date('2020-04-02')
end_date <- Sys.Date()
gagnagerdir <- unique(bcs_data$data_length_of_stay$censored)
aldurshopar <- unique(bcs_data$data_length_of_stay$age_group_simple) #list('0-50', '51+')
states <- unique(bcs_data$data_length_of_stay$state)
```

Skýrslur {id=skyrslur data-icon="fa-th-large"}
=======================================================================

Stillingar {.sidebar}
-------------------------------------------------------------

```{r}
helpText('Veljið dagsetningu til að birta skýrslu fyrir')
sliderInput('dagsetning_sk', 'Dagsetning:', 
            min = start_date, max = max(bcs_data$data_all_simulation$date),
            value = max(bcs_data$data_all_simulation$date), step = 1, timeFormat = "%d %b")
actionButton('saekja_gogn', label = 'Sækja ný gögn')
observeEvent(input$saekja_gogn, {
  msg <- get_and_save_new_data(bcs_data)
  showNotification(msg, duration = 4, id = 'msg_saekja_gogn', type = 'message')
  bcs_data <- readRDS('input/bcs_data.rds')
  bcs_data$data_length_of_stay <- bcs_data$data_length_of_stay %>% recode_states()
})
```


skyrsla-header {data-height=50px}
-----------------------------------------------------------

#### Spá um fjölda smitaðra einstaklinga í hverri stöðu á hverjum degi

```{r simulation_data}
# Make the simulation data reactive on date slider
data_simulation_quantiles <- reactive({
  bcs_data$data_all_simulation %>% 
    filter(date == input$dagsetning_sk) %>%
    mutate(date_spa = date + day) %>%
    gather(key = 'state', value = 'count', 2:6) %>% 
    recode_states() %>% 
    group_by(date_spa, state) %>% 
    summarize(median = round(median(count)), 
              quantile975 = round(quantile(count, probs=0.975))) %>%
    ungroup()
})

#' Plot plots from the forecast report. Requires the data_simulation_quantiles reactive to exist
plot_simulation <- function(state) {
    if(nrow(data_simulation_quantiles()[data_simulation_quantiles()$state==state, ]) < 1) {
        ggplot() +
            geom_text(aes(x=10, y = 10, label = 'Spá vantar')) +
            lims(x=c(0,30), y=c(0,100)) +
            theme_minimal()
        stop()
    }
    p_data <- data_simulation_quantiles()[data_simulation_quantiles()$state==state, ] %>% 
        gather('key', 'value', -date_spa, -state) %>%
        mutate(key = key %>% recode(median = "Líkleg spá",
                                    quantile975 = "Svartsýn spá"))
    ggplot(data = p_data, aes(x = date_spa, y = value)) +
        geom_line(aes(linetype = key, alpha = key), col = "blue4") +
        # geom_text(aes(label = value, alpha = key), col = "blue4") +
        # scale_x_date(date_breaks = "2 days", date_labels = "%m-%d", expand = c(0,0.5)) +
        labs(x = '', y = 'Fjöldi', linetype = '', alpha = '') +
        scale_alpha_manual(values = c(1, 0.7)) +
        theme_minimal()
}

plot_ferguson_prediction_state <- function(state_f, prediction_dat){
    if(nrow(prediction_dat[prediction_dat$state==state_f, ]) < 1) {
        ggplot() +
            geom_text(aes(x=10, y = 10, label = 'Spá vantar')) +
            lims(x=c(0,30), y=c(0,100)) +
            theme_minimal()
        stop()
    }
    prediction_dat <- gather(prediction_dat, key, value, median, upper) %>%
        mutate(key = key %>% recode(median = "Líkleg spá",
                                    upper = "Svartsýn spá"))
    # ggplot(filter(prediction_dat, state==state_f & model==1), aes(x=date, y=value)) + 
    #     geom_line(aes(lty=key, alpha=key), col = "blue4") + 
    #     scale_linetype_manual(values=c("solid", "dashed")) +
    #     labs(x = '', y = 'Fjöldi', linetype = '', alpha = '') +
    #     scale_alpha_manual(values = c(1, 0.7)) +
    #     theme_minimal()
    ggplot(filter(prediction_dat, state==state_f), aes(x=date, y=value)) + 
        geom_line(aes(lty=key, alpha=key), col = "blue4") + 
        scale_linetype_manual(values=c("solid", "dashed")) +
        labs(x = '', y = 'Fjöldi', linetype = '', alpha = '') +
        scale_alpha_manual(values = c(1, 0.7)) +
        theme_minimal()
}

# Göngudeild
window_size <- 7

outpatient_clinic_sim_visits <- reactive({
  prop_visit_for_date <- data_prop_visits %>%
    filter(date == input$dagsetning_sk - window_size) %>%
    select(prop_visits_last_week) %>%
    as.numeric()
  bcs_data$data_all_simulation %>%
    mutate(count_visits = home * prop_visit_for_date) %>%
    group_by(date) %>%
    summarise(median = round(median(count_visits)),
              quantile975 = round(quantile(count_visits,probs=0.975))) %>%
    ungroup()
})
```

skyrsla-efri-röð
--------------------------------------

### Heimaeinangrun

```{r}
renderPlotly({
    p <- plot_simulation('Heimaeinangrun')
    p <- p + ylim(0,1000)
    ggplotly(p, tooltip = list('linetype', 'date', 'value'))
})
```


### Göngudeild

```{r}
renderPlotly({
    p <- ggplot() + theme_minimal()
    ggplotly(p)
})
# renderPlotly({
#     p_data <- outpatient_clinic_sim_visits() %>%
#     gather('key', 'value', -date) %>%
#     mutate(key = key %>% recode(median = "Líkleg spá",
#                                 quantile975 = "Svartsýn spá"))
#   ggplot(data = p_data,
#          aes(x = date, y = value)) +
#     geom_line(aes(lty = key), col = "blue4", size = 0.7) +
#     labs(x = '', y = 'Fjöldi') +
#     theme_minimal() +
#     theme(legend.position = "top",
#           legend.title = element_blank())
# })
```

skyrsla-neðri-röð
------------------------------

### Legudeild
```{r}
renderPlotly({
    p <- plot_simulation('Legudeild')
    p <- p + ylim(0, 50)
    ggplotly(p, tooltip = list('linetype', 'date', 'value'))
})
```


### Gjörgæsla
```{r}
renderPlotly({
    p <- plot_simulation('Gjörgæsla')
    p <- p + ylim(0, 20)
    ggplotly(p, tooltip = c("value", "date", "key"))
})
```

<!-- Skýrsla footer {data-height=30} -->
<!-- ------------------------- -->
<!-- - Þetta spálíkan spáir fyrir um fjölda einstaklinga fjórar vikur fram í tímann.  -->
<!-- - Spálíkanið nýtir tvenns konar gögn, annars vegar spá um fjölda nýrra smita sem fæst af síðunni covid.hi.is og hins vegar söguleg gögn um Covid sjúklinga frá Landspítalanum.  -->
<!-- - Komur á göngudeild eru áætlaðar út frá spáðum fjölda í heimaeinangrun og hlutfalli þeirra sem voru í heimaeinangrun í síðustu viku og komu á göngudeild. -->



Sviðsmyndir {id=svidsmyndir_old data-icon="fa-project-diagram"}
===============================================

Stillingar {.sidebar}
---------------------------------------------------

```{r}
helpText('Sláið inn nýjar auka forsendur og veljið "Keyra hermun". 
         Nokkurn tíma gæti tekið fyrir keyrsluna að klárast.')
dateInput('sv_date', 'Dagsetning', value = Sys.Date(), min = '2020-03-01', max = Sys.Date() + 30)

div(numericInput('sv_fjoldi', 'Fjöldi', min = 0, max = 100, step = 1, value = 0, width = 20),  selectInput('sv_age', 'Aldursbil', choices = c('0-50', '51-75', '>75'), selected = '0-50', width = 20), id='groupInputs')
div(numericInput('sv_fjoldi', 'Fjöldi', min = 0, max = 100, step = 1, value = 0, width = 20),  selectInput('sv_age', 'Aldursbil', choices = c('0-50', '51-75', '>75'), selected = '51-75', width = 20), id='groupInputs')
div(numericInput('sv_fjoldi', 'Fjöldi', min = 0, max = 100, step = 1, value = 0, width = 20),  selectInput('sv_age', 'Aldursbil', choices = c('0-50', '51-75', '>75'), selected = '+75', width = 20), id='groupInputs')

actionButton("sv_keyra", "Keyra hermun")

```


sviðsmyndir-legudeild
-------------------------------

### Legudeild

```{r}
renderPlotly({
  p <- plot_simulation('Legudeild') + ylim(0, 100)
  ggplotly(p, tooltip = list('linetype', 'date', 'value'))
  observeEvent(input$sv_keyra, {
    p <- p + geom_line(aes(y = value + 5, lty = key, size = 'Ný sviðsmynd'), col = "red", size = 0.7)
    ggplotly(p, tooltip = list('linetype', 'date', 'value'))
  })    
  ggplotly(p, tooltip = list('linetype', 'date', 'value'))
})

```

sviðsmyndir-gjörgæsla
------------------------------

### Gjörgæsla

```{r}
renderPlotly({
    p <- plot_simulation('Gjörgæsla') + ylim(0, 50)
    if (input$sv_fjoldi > 0) {
    p <- p + 
      geom_line(aes(y = value + 2, lty = key, size = 'Ný sviðsmynd'), col = "red", size = 0.7)
    }
    ggplotly(p, tooltip = list('linetype', 'date', 'value'))
})
```


Sviðsmyndir SIR {id=svidsmyndir data-icon="fa-project-diagram"}
===============================================

Stillingar {.sidebar}
---------------------------------------------------

```{r}
# Fyrir plottun
dateInput('sir_start_date', 'Dagsetning fyrsta smits',
          value = Sys.Date() + 1, min = '2020-05-01', max = Sys.Date() + 30)
numericInput("sir_utsettir", 'Fjöldi smita',
            min = 10, max = 1000, value = 100, step = 10)
sliderInput("sir_r_eff", 'Virkur smitstuðull (R)',
            min = 0.1, max = 3, step = 0.1, value = 1)
# sliderInput("sir_smitdagar", 'Meðallengd veikinda í dögum',
#             min = 7, max = 21, value = 14)
sliderInput("sir_dagar", 'Fjöldi daga til að teikna',
            min = 5, max = 75, step = 5, value = 25)

# Fyrir hermun
# Staða við greiningu
# hr()
# sliderInput("sir_stada", 
#             HTML('Hlutfall sem greinist heima (%)'),
#             min = 0, max = 100, value = 70)
# 
# renderText(
#   paste0('Heima: ', as.numeric(input$sir_stada), '%', 
#   ' , ', 
#   'Í innlögn: ', 100 - as.numeric(input$sir_stada), '%'))

hr()
# Aldursdreifing
# radioButtons('sir_aldur_val', 'Aldursdreifing', choices = c('Þjóðar', 'Faraldurs', 'Skv. Stillingu:'))
radioButtons('sir_aldur_val', 'Aldursdreifing', choices = c('Þjóðar', 'Faraldurs'))
# conditionalPanel(
#   "input.sir_aldur_val == 'Skv. Stillingu:'",
#   sliderInput("sir_aldur_dreif", 
#               HTML('Hlutfall undir 50 ára aldri (%)'),
#               min = 0, max = 100, value = c(60))
# )
# renderText(
#   if (input$sir_aldur_val == 'Skv. Stillingu:') {
#     paste0('0-50 ára: ', as.numeric(input$sir_aldur_dreif), '%', ' , ',
#            '>50 ára: ', 100 - as.numeric(input$sir_aldur_dreif), '%')
# })

#Age distributions
aldur_faraldur <- get_patient_transitions_at_date('base',date_observed = as.Date('2020-05-08')) %>%
    distinct(patient_id) %>%
    inner_join(individs_splitting_variables,by='patient_id') %>%
    rename(splitting_variable=!!'age_official') %>%
    group_by(splitting_variable) %>%
    summarise(prop=n()) %>%
    ungroup() %>%
    mutate(prop=prop/sum(prop))

aldur_hagstofa <- read_delim("aldur_hagstofa.csv", ";", escape_double = FALSE, 
                             locale = locale(encoding = "ISO-8859-2"), trim_ws = TRUE)
aldur_hagstofa$Aldur <- parse_number(aldur_hagstofa$Aldur)
aldur_hagstofa$Aldur[1] <- 0

aldur_hagstofa$splitting_variable <- cut(aldur_hagstofa$Aldur, breaks = c(seq(0, 80, by = 10), Inf), labels = aldur_faraldur$splitting_variable, right = FALSE)

aldur_hagstofa <- aldur_hagstofa %>% group_by(splitting_variable) %>%
                    rename("Number"="2020") %>%
                    summarise(Number=sum(Number)) %>%
                    mutate(prop=Number/sum(Number))

# age_dist <- eventReactive(input$sir_keyra, {
#   switch(input$sir_aldur_val,
#                    'Þjóðar' = aldur_hagstofa,
#                    'Faraldurs' = aldur_faraldur,
#                    aldur_faraldur)
# })

age_dist <- reactive({
  if (input$sir_aldur_val == 'Þjóðar')
    aldur_hagstofa
  else if (input$sir_aldur_val == 'Faraldurs')
   aldur_faraldur
  else
    stop("Unexpected dataset")
})

# age_dist <- switch(input$sir_aldur_val,
#                    'Þjóðar' = aldur_hagstofa,
#                    'Faraldurs' = aldur_faraldur,
#                    aldur_faraldur)
  
actionButton("sir_keyra", "Keyra hermun")
```

```{r}
# Create placeholder for the downloadButton
uiOutput("downloadUI")
```

```{r}
# Create the actual downloadButton
output$downloadUI <- renderUI( {
  tagList(
    downloadButton("downBtn1", "Sækja nýsmit"),
    downloadButton("downBtn2", "Sækja first state")
  )
})

# Add download handling
output$downBtn1 <- downloadHandler(
  filename = function() {
    paste0(Sys.Date(), "_1_scenario_infected.csv")
  },
  content = function(file) {
    write.csv(round(out() * input$sir_utsettir) %>%
                mutate(I_diff = c(1, diff(I)),
                       R_diff = c(0, diff(R)),
                       date_diagnosis = input$sir_start_date + row_number() - 1,
                       count = I_diff + R_diff,
                       count = pmax(count, 0)) %>% 
                select(date_diagnosis, count), 
              file, row.names = FALSE)
  }
)

#Þarf að laga
output$downBtn2 <- downloadHandler(
  filename = function() {
    paste0(Sys.Date(), "_1_scenario_first_state.csv")
  },
  content = function(file) {
    write.csv(round(out() * input$sir_utsettir) %>%
                mutate(I_diff = c(1, diff(I)),
                       R_diff = c(0, diff(R)),
                       date_diagnosis = input$sir_start_date + row_number() - 1,
                       count = I_diff + R_diff,
                       count = pmax(count, 0)) %>% 
                select(date_diagnosis, count), 
              file, row.names = FALSE)
  }
)
```

Sviðsmyndir SIR
------------------------------

### Ný smit
```{r}
## Create an SIR function
sir <- function(time, state, parameters) {
  
  with(as.list(c(state, parameters)), {
    
    dS <- -beta * S * I
    dI <-  beta * S * I - gamma * I
    dR <-                 gamma * I
    
    return(list(c(dS, dI, dR)))
  })
}

### Set parameters
out <- eventReactive(input$sir_keyra, {
  r_eff <- reactiveVal(input$sir_r_eff, 1)
  n_sus <- reactiveVal(input$sir_utsettir, 100)
  n_sus2 <- 200
  # n_dagar_smit <- reactiveVal(input$sir_smitdagar, 14)
  n_dagar_smit <-  17
  n_dagar <- reactiveVal(input$sir_dagar, 30)
  dags_upphaf <- reactiveVal(input$sir_start_date, Sys.Date() + 1)
  ## Proportion in each compartment: Susceptible 0.999999, Infected 0.000001, Recovered 0
  init       <- c(S = 1-1/n_sus(), I = 1/n_sus(), R = 0.0)
  ## beta: infection parameter; gamma: recovery parameter
  # parameters <- c(beta = r_eff(), gamma = 1/n_dagar_smit())
  parameters <- c(beta = r_eff(), gamma = 1/n_dagar_smit)
  ## Time frame
  times      <- seq(0, n_dagar(), by = 1)
  
  ## Solve using ode (General Solver for Ordinary Differential Equations)
  out <- ode(y = init, times = times, func = sir, parms = parameters)
  # change to data frame
  out <- as.data.frame(out)
  ## Delete time variable
  out$time <- NULL
  out
})

input_values <- eventReactive(input$sir_keyra, {
  data.frame("sir_utsettir"=input$sir_utsettir, 
             "sir_start_date"=input$sir_start_date, 
             "sir_dagar"=input$sir_dagar)
})

smit_folk <- eventReactive(input$sir_keyra, {
smit_folk <- round(out() * input_values()$sir_utsettir) %>%
             mutate(I_diff = c(1, diff(I)),
                    R_diff = c(0, diff(R)),
                    nysmit = I_diff + R_diff,
                    nysmit = pmax(nysmit, 0),
                    dags = input_values()$sir_start_date + row_number() - 1)
#sum(smit_folk$nysmit)
#smit_folk
})

renderPlotly({
p <- ggplot(smit_folk()) +
    geom_col(aes(x=dags, y=nysmit)) +
    theme_minimal() + 
    labs(y="Ný smit", x=NULL)
ggplotly(p)
})
```

### SIR kúrfur
```{r}
renderPlot({
  matplot(x = 0:input_values()$sir_dagar, y = out() * input_values()$sir_utsettir, type = "l",
          xlab = "Dagar", ylab = "Fjöldi einstaklinga", main = "Fjöldi smita - SIR Model",
          lwd = 1, lty = c(1,1,2), bty = "l", col = c('Grey', 'Red', 'Grey'))
  legend(input_values()$sir_dagar, max(out() * input_values()$sir_utsettir), 
         c("Útsettir", "Smitaðir", "Batnað"), yjust = 1, xjust = 1,
         lty = c(1,1,2), col = c('Grey', 'Red', 'Grey'), bg = 'White', box.col = 'White')
})
```


sviðsmyndir-hermunarútkoma
-------------------------------
### Heimaeinangrun - Ferguson hermun
```{r}
los_best <- data.frame("vd"=17, "ld"=8, "gd"=6, "pre_lega"=9, "pre_icu"=1)

tot_dat <- eventReactive(input$sir_keyra, {
    smit_folk <- round(out() * input$sir_utsettir) %>%
    mutate(I_diff = c(1, diff(I)),
         R_diff = c(0, diff(R)),
         nysmit = I_diff + R_diff,
         nysmit = pmax(nysmit, 0),
         dags = input$sir_start_date + row_number() - 1)
sum(smit_folk$nysmit)
infected_distr <- smit_folk %>%
                  group_by(dags) %>%
                  mutate(prob=1) %>%
                  rename(date=dags, new_cases=nysmit)

dates <- seq(min(infected_distr$date), max(infected_distr$date),by=1)

#wuhan_fixed_LOS <- run_ferguson_simulation('age_official',infected_distr, transitions_location='wuhan', los_location='wuhan')
# iceland_age_official_fixed_LOS <-run_ferguson_simulation('age_official',infected_distr,
#                                                          transitions_location='iceland', los_location='wuhan')
iceland_age_official_fixed_LOS <- run_ferguson_simulation2(infected_distr, los_best, age_dist())
#tot_dat <- bind_rows(wuhan_fixed_LOS,iceland_age_official_fixed_LOS,.id='model') %>% 
#           mutate(state=ifelse(state=="hospital", "inpatient_ward", state))

iceland_age_official_fixed_LOS %>% 
          mutate(state=ifelse(state=="hospital", "inpatient_ward", state))
})
```
```{r}
renderPlotly({
p <- plot_ferguson_prediction_state("home", tot_dat())
ggplotly(p, tooltip = list('linetype', 'date', 'value'))
})
```

### Legudeild - Ferguson hermun

```{r}
##ath notar alltaf aldursdreifingu faraldurs og hlutfall sem greinist heima hefur engin áhrif

renderPlotly({
p <- plot_ferguson_prediction_state("inpatient_ward", tot_dat())
ggplotly(p, tooltip = list('linetype', 'date', 'value'))
})

```

### Gjörgæsla - Ferguson hermun
```{r}
renderPlotly({
p <- plot_ferguson_prediction_state("intensive_care_unit", tot_dat())
ggplotly(p, tooltip = list('linetype', 'date', 'value'))
})
```

```{r}
### Niðurstaða hermunar
# renderPlotly({
#   p <- plot_simulation('Legudeild') + ylim(0, 100)
#   ggplotly(p, tooltip = list('linetype', 'date', 'value'))
#   observeEvent(input$sv_keyra, {
#     p <- p + geom_line(aes(y = value + 5, lty = key, size = 'Ný sviðsmynd'), col = "red", size = 0.7)
#     ggplotly(p, tooltip = list('linetype', 'date', 'value'))
#   })
#   ggplotly(p, tooltip = list('linetype', 'date', 'value'))
# })

```


```{r}
# renderPlotly({
#     p <- plot_simulation('Gjörgæsla') + ylim(0, 50)
#     if (input$sv_fjoldi > 0) {
#     p <- p +
#       geom_line(aes(y = value + 2, lty = key, size = 'Ný sviðsmynd'), col = "red", size = 0.7)
#     }
#     ggplotly(p, tooltip = list('linetype', 'date', 'value'))
# })
```


```{r}
### Legudeild
# renderPlotly({
#     p <- plot_simulation('Legudeild')
#     p <- p + ylim(0, 50)
#     ggplotly(p, tooltip = list('linetype', 'date', 'value'))
# })
```
```{r}
# renderPlotly({
#     p <- plot_ferguson_prediction_state("inpatient_ward", tot_dat)
#     ggplotly(p, tooltip = list('linetype', 'date', 'value'))
# })
```


```{r}
### Gjörgæsla
# renderPlotly({
#     p <- plot_simulation('Gjörgæsla')
#     p <- p + ylim(0, 20)
#     ggplotly(p, tooltip = c("value", "date", "key"))
# })
```
```{r}
# renderPlotly({
#     p <- plot_ferguson_prediction_state("intensive_care_unit", tot_dat)
#     ggplotly(p, tooltip = list('linetype', 'date', 'value'))
# })
```

Forsendur {data-icon="fa-chart-bar"}
=======================================================================

Stillingar {.sidebar}
---------------------------------------------------

```{r}
sliderInput('dagsetning', 'Dagsetning:', min = start_date, max = max(bcs_data$data_length_of_stay$date),
            value = end_date, step = 1, timeFormat = "%d %b")
checkboxInput('festa_asa', 'Festa ása', value = FALSE)
checkboxGroupInput('aldur', label = 'Aldurshópar:', 
                   choices = aldurshopar, selected = aldurshopar)
checkboxGroupInput('state', label = 'Staða:', 
                   choices = states, selected = states)
checkboxGroupInput('gagnagerd', label = 'Censored:',
                   choices = gagnagerdir, selected = gagnagerdir)
selectInput('fill_by', 'Lita eftir:', c(names(bcs_data$data_length_of_stay)[1:3]), selected = 'censored')
selectInput('facet', 'Facet eftir:', c('-', names(bcs_data$data_length_of_stay)[1:3]))

```

dreifinga-tabs {.tabset .tabset-fade}
-----------------------------------------------------------------------

### Length of Stay 

```{r}
dataset <- reactive({
  bcs_data$data_length_of_stay %>%  
    filter(date == input$dagsetning,
           state %in% input$state,
           age_group_simple %in% input$aldur, 
           censored %in% input$gagnagerd)
})

# renderText(print(as.Date(input$dagsetning, origin = '1970-01-01', format="%d %b")))
renderPlot({
  p <- ggplot(dataset(), aes(x=state_duration, y=count, fill = censored)) + 
    geom_col(position = 'dodge') +
    scale_fill_manual(values = palette1) +
    # scale_fill_viridis_d(begin = 0.1, end = 0.6) +
    theme_minimal()
  
  p <- p + aes_string(fill = input$fill_by)
  
  if (input$facet != '-')
    p <- p + facet_wrap(paste0('~', input$facet), scales = 'free')
  if(input$festa_asa)
    p <- p + lims(x = c(0, 35), y = c(0, max(bcs_data$data_length_of_stay$count)))
  print(p)
})
```


### Transition Matrix Test [WIP]

```{r}
links <- list(
  source = c(0,1,0,1,2),
  target = c(1,2,3,3,3),
  value =  c(4,2,2,2,2))
  
nodes <-  list(
  label = c("home", "inpatient_ward", "intensive_care_unit", "recovered"),
  color = c("blue", "blue", "blue", "blue"),
  pad = 15,
  thickness = 20,
  line = list(
    color = "black",
    width = 0.5
  )
)

fig <- plot_ly(
  type = "sankey",
  orientation = "h",
  node = nodes,
  link = links
)

fig <- fig %>% layout(
  title = "Basic Sankey Diagram",
  font = list(
    size = 10
  )
)

fig
```


<!-- Gagnagæði {data-icon="fa-tasks"} -->
<!-- ======================================================================= -->

<!-- Stillingar {.sidebar} -->
<!-- --------------------------------------------------- -->



<!-- ### ANNAÐ ### -->

